-- File: subtractor_tb_simple.vhd
library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity subtractor_tb is
end entity subtractor_tb;

architecture testbench of subtractor_tb is
    constant WIDTH : integer := 4;
    constant CLK_PERIOD : time := 10 ns;
    
    component subtractor
        generic (WIDTH : integer := 4);
        port (
            clk : in std_logic;
            a   : in std_logic_vector(WIDTH-1 downto 0);
            b   : in std_logic_vector(WIDTH-1 downto 0);
            s   : out std_logic_vector(WIDTH-1 downto 0);
            c   : out std_logic
        );
    end component;
    
    signal clk : std_logic := '0';
    signal a   : std_logic_vector(WIDTH-1 downto 0) := (others => '0');
    signal b   : std_logic_vector(WIDTH-1 downto 0) := (others => '0');
    signal s   : std_logic_vector(WIDTH-1 downto 0);
    signal c   : std_logic;
    
    signal sim_done : boolean := false;
    
begin
    UUT: subtractor
        generic map (WIDTH => WIDTH)
        port map (clk => clk, a => a, b => b, s => s, c => c);
    
    -- Clock process
    clk_process: process
    begin
        while not sim_done loop
            clk <= '0';
            wait for CLK_PERIOD/2;
            clk <= '1';
            wait for CLK_PERIOD/2;
        end loop;
        wait;
    end process;
    
    -- Stimulus process
    stimulus: process
        variable error_count : integer := 0;
        variable expected : std_logic_vector(WIDTH downto 0);
    begin
        wait for 100 ns;
        
        -- Test all combinations
        for i in 0 to 2**WIDTH-1 loop
            for j in 0 to 2**WIDTH-1 loop
                a <= std_logic_vector(to_unsigned(i, WIDTH));
                b <= std_logic_vector(to_unsigned(j, WIDTH));
                
                wait until rising_edge(clk);
                wait for CLK_PERIOD/4;
                
                -- Expected: a - b (usando signed para manejar negativos)
                expected := std_logic_vector(
                    resize(signed(a), WIDTH+1) - resize(signed(b), WIDTH+1)
                );
                
                -- Check result
                if (c & s) /= expected then
                    error_count := error_count + 1;
                    assert false
                        report "Error at a=" & integer'image(i) & 
                               ", b=" & integer'image(j)
                        severity error;
                end if;
                
                wait until rising_edge(clk);
            end loop;
        end loop;
        
        -- Final report
        assert false
            report "Subtraction test complete. Errors: " & integer'image(error_count)
            severity note;
        
        sim_done <= true;
        wait;
    end process;
    
end architecture testbench;